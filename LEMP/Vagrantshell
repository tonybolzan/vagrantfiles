# Clean Vagrant Machine to LEMP Stack in Debian 7 (wheezy) with PHP5.5, Nginx, MySQL
# 
# Author: Tonin R. Bolzan <tonin@bolzan.io>
# Available at: https://github.com/tonybolzan/vagrantfiles
# 
# Dependencies
#   Virtualbox 4.3.10
#   Virtualbox Extension Pack
#   Vagrant >= 1.5.0

# Do not change from here.

echo 'Adding repository dotdeb.org'
wget -qO - http://www.dotdeb.org/dotdeb.gpg | sudo apt-key add -
cat > /etc/apt/sources.list.d/dotdeb.list <<EOF
deb http://packages.dotdeb.org wheezy all
deb-src http://packages.dotdeb.org wheezy all
deb http://packages.dotdeb.org wheezy-php55 all
deb-src http://packages.dotdeb.org wheezy-php55 all
EOF

echo 'Updating S/O'
apt-get -qq update
apt-get -yqq upgrade

echo 'Installing Packages'
debconf-set-selections <<< 'mysql-server mysql-server/root_password password root'
debconf-set-selections <<< 'mysql-server mysql-server/root_password_again password root'

apt-get -yqq install curl whois vim git htop nginx php5 php5-common php5-cli php5-cgi php5-fpm php5-apcu php5-curl php5-gd php5-imagick php5-mysql php5-sqlite php5-mcrypt php5-intl php5-readline php5-json php5-xmlrpc php5-xdebug php-pear mysql-server mysql-client sqlite3

echo 'Setting up Xdebug'
mkdir -p /var/log/xdebug
chmod 777 /var/log/xdebug
cat >> /etc/php5/mods-available/xdebug.ini <<EOF
xdebug.remote_enable = on
xdebug.remote_connect_back = on
xdebug.remote_handler = dbgp
xdebug.remote_mode = req
xdebug.remote_port = 9000
xdebug.remote_log = /var/log/xdebug/xdebug.log
xdebug.profiler_output_dir = /var/log/xdebug
xdebug.profiler_enable_trigger = on
xdebug.max_nesting_level = 200
xdebug.idekey = VAGRANT
EOF

echo 'Setting up PHP'
cp /usr/share/php5/php.ini-development /etc/php5/fpm/php.ini
sed -i '/^short_open_tag/c short_open_tag = On' /etc/php5/{cgi,cli,fpm}/php.ini
sed -i '/^post_max_size/c post_max_size = 32M' /etc/php5/{cgi,cli,fpm}/php.ini
sed -i '/^upload_max_filesize/c upload_max_filesize = 32M' /etc/php5/{cgi,cli,fpm}/php.ini
#sed -i '/^;date.timezone/c date.timezone = America/Sao_Paulo' /etc/php5/{cgi,cli,fpm}/php.ini

echo 'Setting up PHP-FPM'
sed -i '/^;listen.mode/c listen.mode = 0666' /etc/php5/fpm/pool.d/www.conf

echo 'Setting up Nginx'
# http://docs.vagrantup.com/v2/synced-folders/virtualbox.html
sed -i 's/\(.*sendfile\).*;$/\1 off;/g' /etc/nginx/nginx.conf

cat > /etc/nginx/sites-available/default <<'EOF'
server {
    listen 80 default_server;
    listen [::]:80 default_server ipv6only=on;

    root /var/www/public_html/;

    index index.html index.php;

    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    location ~ /\.ht {
        deny all;
    }

    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass unix:/var/run/php5-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
    }

    location ~ \.(js|css|png|jpg|jpeg|gif|swf|ico|pdf|mov|fla|zip|rar)$ {
        try_files $uri =404;
        log_not_found off;
    }

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        log_not_found off;
        access_log off;
    }
}
EOF

echo 'Setting up MySQL'
sed -i '/^bind-address/c bind-address = 0.0.0.0' /etc/mysql/my.cnf
mysql -uroot -proot -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY 'root' WITH GRANT OPTION;"

echo 'Restarting PHP, Nginx and MySQL'
service php5-fpm restart
service nginx restart
service mysql restart

echo -e '\n\nYou can access this server in:'
for IP in $(hostname -I);do
    echo "http://$IP/";
done
